# RAG (Retrieval Augmented Generation) とは

RAG（Retrieval Augmented Generation）とは、生成AIが質問に回答する際に、生成AIのデータベースに加え、外部の情報源からも情報を検索し、回答の精度を向上させる技術です。これにより、より正確で最新の情報を基にした回答が可能になります。

## 要素

‐ Query Encoder
- Retriever (Search/Query Engine/Executer)
- Generator (LLM)

- Pre-proessing
- Post-processing

## 情報とは

- 構造化データ: スキーマがあるデータ
- 非構造化データ: スキーマを持たない文字列やバイナリ（画像、音声、動画、特定の形式のファイルなど）

## Query Encoder

ユーザーの入力やその他の付加情報を使って、Retriever が利用できる形式に変換

入力: 
- 自然言語
- キーワード、候補からの選択結果
- 音声、画像、動画
- etc.

出力: 
- SQL/T-SQL/Cypher などのデータベースクエリ
- Web 検索で利用できるキーワードや URL
- ベクトル (embedding)
- OCR や STTなどで 構造化されたデータ
- python/C# などの実行可能なコード
- etc.

エンジン:
- Language Model
- 学習済深層学習モデル
- コード
- etc.

## Retriever

Query Encoder から受け取った出力を使って情報を取得する

- SQL Server/Oracle/Cosmos DB/Azure AI Search 
  - Native Query
  - Embedding
  - フルテキスト検索
  - ハイブリッド検索
  - etc
- Web Search/Wikipedia Search などインターネットへの検索
- ストレージやファイルを扱う製品などでの検索
- コードの実行によるデータの生成
  - コード単体の計算で完結するもの
  - CSV,JSON,YAML,Parquet などデータを読み込む場合
  - 外部システムとの連携
  - etc.
- etc.

出力される情報のフォーマットは様々
- 構造化データ
- 非構造化データ
  - ドキュメントのチャンク
  - 音声、画像、動画
  - Office ファイル
  - etc.

## 実行のタイミング

- 独自ロジックで RAG の必要性を判定して実行
- Function Calling など LLM の判断により実行

# 最近よく聞く RAG

## ドキュメントをチャンクしてベクトル検索

ユーザーの質問の意図を理解した検索を行えるシステムとして台頭

### メリット
- 大量ドキュメントでもクエリ実行効率が良い
- セマンティック検索が可能
- 部分的な更新が比較的容易
- インデックス生成のコストが低く高速
- etc.

### デメリット
- キーワード検索に向いていない
- ドキュメントの内容によって特徴量の抽出にばらつき
- チャンクのストラテジーが多岐にわたる
- ドキュメント全体に関連する検索効率が悪い

ドキュメントのセマンティックな特徴を捉えるために embedding を行うため、どのようなモデルを使うかや、チャンクに区切る判断が問われる他、ユーザーのクエリがより意図にそったものである必要が高い。

### どんなクエリに向いている？

ドキュメント次第とユーザークエリ次第

現在はベクトル検索とキーワード検索を併用するハイブリッド検索製品がある

## GraphRAG

Graph DB を軸とした検索

### 要素

- グラフの生成
- クエリ

### グラフの生成

Graph DB はどのタイミングでどのように準備されたものでも問題ないが、GraphRAG の文脈では、グラフデータの自動生成もスコープになっていることが多い。またトリプル抽出とクエリ変換で利用する手法は近い方が精度が高い

- トリプル抽出
- ノードとエッジの付加情報（ベクトル込み）
- エッジ数を使ったノードの重みづけ
- ノードの階層抽出
- クラスタリングを使ったコミュニティの抽出

#### ノードとエッジのデザイン

- ノードの粒度や種類
- エッジの種類
- 属性の候補
- ベクトル化する情報の候補

例：「日本の首都は東京である」

(n: 日本)-[r: 首都]->(m: 東京)

- トリプル： 日本、首都、東京
- ノード： 日本、東京
- エッジ： 首都

|id|type|name|
|---|---|---|
|1|country|日本|
|2|city|東京|

|id|source|target|
|---|---|---|
|1|1(日本)|2(東京)|


例：「日本の首都は東京である」

(n: 日本)

- トリプル: なし

|id|type|name|capital|
|---|---|---|---|
|1|country|日本|東京|

#### Graph に対する付加情報

- ノード間の階層
- クラスタリング
- クラスタレベルのサマリー

サマリについては、オリジナル文章を MapReduce したものであるが、ノードやクラスタ観点からの抽出となるため、より意味を持った情報となりやすい。

### クエリ

ユーザーの質問によってクエリの戦略を検討する必要がある

- クエリのスコープ
- クエリ変換

#### クエリのスコープ

- 文章全体に対する質問
- 特定のノードやエッジに関する質問

ユーザー入力は LM や nltk を使ってトリプルを抽出するが、Cypher のようなグラフクエリを作成してノードを起点に検索をするべきか、クラスタレベルのサマリーに対してベクトルやキーワード検索をするべきかの考慮が必要。

- サマリーに対してクエリしてからグラフ検索もする？
- グラフ検索した場合にサマリーは使う？
- 元になったスニペットの情報を利用する？

#### クエリ変換

ユーザー入力から Cypher クエリ変換やトリプル抽出をする場合、グラフ DB に存在するノードやエッジにマッチするものを抽出できるようにする。

# Microsoft GraphRAG モジュール

https://github.com/microsoft/graphrag
https://microsoft.github.io/graphrag